<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miro Member</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family:system-ui;
  margin:0;
  background:#f4f6fb;
  color:#0b2b5a
}
.wrap{max-width:420px;margin:0 auto;padding:16px}

/* ===== USER HEADER ===== */
.user-head{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:12px
}
.user-name{font-size:16px;font-weight:800}
.user-type{
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #c7d2fe;
  background:#eef2ff;
  font-weight:600
}

/* ===== CARD ===== */
.card{
  background:linear-gradient(135deg,#0b63ce,#0a3f8f);
  color:#fff;
  border-radius:22px;
  padding:18px;
  position:relative;
  box-shadow:0 12px 28px rgba(0,0,0,.18)
}
.logo{
  width:30px;
  position:absolute;
  top:16px;
  right:16px
}
.level{font-size:13px;opacity:.9}
.points{
  font-size:44px;
  font-weight:900;
  margin:6px 0 4px
}
.expire{font-size:13px;opacity:.9}
.card-footer{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  opacity:.85;
  margin-top:14px
}

/* ===== SECTIONS ===== */
.sec{margin-top:20px}
.h{font-weight:900;margin-bottom:8px}

/* ===== COUPONS ===== */
.coupon-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px
}
.coupon{
  background:#fff;
  border-radius:14px;
  padding:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.06)
}
.coupon .name{font-weight:800;font-size:14px}
.coupon .meta{font-size:12px;color:#6b7280;margin-top:2px}
.coupon button{
  width:100%;
  margin-top:6px;
  padding:8px;
  border-radius:10px;
  border:0;
  font-weight:800;
  background:#16a34a;
  color:#fff;
  font-size:13px
}

/* ===== HISTORY ===== */
.box{
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.05)
}
</style>
</head>

<body>
<div class="wrap">

  <!-- USER HEADER -->
  <div class="user-head">
    <div class="user-name" id="userName">-</div>
    <div class="user-type" id="userType">-</div>
  </div>

  <!-- MEMBER CARD -->
  <div class="card">
    <img src="https://i.ibb.co/sdmfJxdW/D.png" class="logo">
    <div class="level" id="level">ระดับ -</div>
    <div class="points" id="redeemPts">0</div>
    <div class="expire" id="expireText">-</div>

    <div class="card-footer">
      <div>แต้มสะสม: <span id="totalPts">0</span></div>
      <div>ใช้ไปแล้ว: <span id="usedPts">0</span></div>
    </div>
  </div>

  <!-- YOUR COUPONS -->
  <div class="sec">
    <div class="h">คูปองของคุณ</div>
    <div id="couponBox" class="coupon-grid"></div>
  </div>

  <!-- REDEEM -->
  <div class="sec">
    <div class="h">แลกคูปองด้วยแต้ม</div>
    <div id="redeemCatalog" class="coupon-grid"></div>
  </div>

</div>

<script>
const LIFF_ID = "2008701497-IOxPqnn3";
const API_URL = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

function animateNumber(el, target){
  let n = 0;
  const step = Math.max(1, Math.floor(target / 40));
  const timer = setInterval(()=>{
    n += step;
    if(n >= target){ n = target; clearInterval(timer); }
    el.innerText = n;
  },20);
}

function fmtThai(d){
  const dt = new Date(d);
  const m = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
  return `${dt.getDate()} ${m[dt.getMonth()]} ${dt.getFullYear()+543}`;
}

async function main(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()){liff.login();return;}
  const profile = await liff.getProfile();

  const mRes = await fetch(`${API_URL}?action=member&userId=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`);
  const member = await mRes.json();

  document.getElementById("userName").innerText = member.name;
  document.getElementById("userType").innerText = member.customer_type || "รายวัน";
  document.getElementById("level").innerText = "ระดับ " + (member.level || "-");

  const wRes = await fetch(`${API_URL}?action=wallet&memberId=${member.member_id}`);
  const wallet = await wRes.json();

  animateNumber(document.getElementById("redeemPts"), wallet.points.redeem || 0);
  document.getElementById("totalPts").innerText = wallet.points.level || 0;

  const used = (wallet.points.level || 0) - (wallet.points.redeem || 0);
  document.getElementById("usedPts").innerText = used > 0 ? used : 0;

  const bucket = wallet.points_expire?.[0];
  document.getElementById("expireText").innerText =
    bucket ? `มี ${bucket.points} แต้ม หมดวันที่ ${fmtThai(bucket.expire)}` : "ไม่มีแต้มใกล้หมดอายุ";

  // coupons owned
  const cBox = document.getElementById("couponBox");
  cBox.innerHTML = "";
  (wallet.coupons || []).forEach(c=>{
    cBox.innerHTML += `
      <div class="coupon">
        <div class="name">${c.name}</div>
        <div class="meta">หมดอายุ ${fmtThai(c.expire_date)}</div>
      </div>`;
  });

  // redeem catalog
  const catalog = [
    {code:"C50",name:"ส่วนลด 50 บาท",cost:50},
    {code:"C100",name:"ส่วนลด 100 บาท",cost:100},
    {code:"P10",name:"ส่วนลด 10%",cost:150}
  ];
  const rBox = document.getElementById("redeemCatalog");
  catalog.forEach(c=>{
    const div = document.createElement("div");
    div.className = "coupon";
    div.innerHTML = `
      <div class="name">${c.name}</div>
      <div class="meta">ใช้ ${c.cost} แต้ม</div>
      <button>แลก</button>`;
    div.querySelector("button").onclick = async ()=>{
      if(!confirm(`ยืนยันแลก ${c.name}`))return;
      const res = await fetch(`${API_URL}?action=redeem_coupon&memberId=${member.member_id}&code=${c.code}`);
      const data = await res.json();
      if(data.success) location.reload();
      else alert(data.error);
    };
    rBox.appendChild(div);
  });
}
main();
</script>
</body>
</html>
