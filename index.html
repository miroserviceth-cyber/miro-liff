<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miro Member</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:system-ui;margin:0;background:#f4f6fb;color:#0b2b5a}
.wrap{max-width:420px;margin:0 auto;padding:16px}

/* ===== CARD ===== */
.card{
  background:linear-gradient(135deg,#0b63ce,#0a3f8f);
  color:#fff;border-radius:20px;padding:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15)
}
.card .name{font-size:14px;opacity:.9}
.card .big{font-size:42px;font-weight:900;margin:6px 0}
.card .sub{font-size:13px;opacity:.9}
.card .row{display:flex;justify-content:space-between;margin-top:8px}

/* ===== SECTION ===== */
.sec{margin-top:18px}
.h{font-weight:900;margin-bottom:8px}
.box{
  background:#fff;border-radius:14px;
  padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.06)
}
.muted{color:#6b7280;font-size:13px}

/* ===== COUPON SMALL ===== */
.coupon{
  display:flex;justify-content:space-between;
  align-items:center;margin-top:8px
}
.coupon button{
  border:0;border-radius:999px;
  padding:6px 12px;font-size:13px;
  background:#16a34a;color:#fff;font-weight:700
}

/* ===== COLLAPSE ===== */
.toggle{cursor:pointer;font-weight:700}
.hide{display:none}
.item{border-top:1px solid #e5e7eb;padding-top:8px;margin-top:8px}
</style>
</head>

<body>
<div class="wrap">

<!-- MEMBER CARD -->
<div class="card">
  <div class="name" id="memberName">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</div>
  <div class="big" id="redeemPts">0</div>
  <div class="sub">‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</div>
  <div class="row">
    <div class="sub">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: <b id="levelPts">0</b></div>
    <div class="sub" id="expireText">-</div>
  </div>
</div>

<!-- COUPON REDEEM -->
<div class="sec">
  <div class="h">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>
  <div id="redeemCatalog"></div>
</div>

<!-- HISTORY -->
<div class="sec">
  <div class="h toggle" onclick="toggle('serviceHist')">üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
  <div id="serviceHist" class="box hide"></div>
</div>

<div class="sec">
  <div class="h toggle" onclick="toggle('couponHist')">üéü ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>
  <div id="couponHist" class="box hide"></div>
</div>

</div>

<script>
const LIFF_ID="2008701497-IOxPqnn3";
const API_URL="https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

function toggle(id){
  document.getElementById(id).classList.toggle("hide");
}

function thai(d){
  const x=new Date(d);
  return `${x.getDate()}/${x.getMonth()+1}/${x.getFullYear()+543}`;
}

async function main(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()){liff.login();return;}

  const p=await liff.getProfile();
  const m=await (await fetch(`${API_URL}?action=member&userId=${p.userId}&name=${p.displayName}`)).json();
  document.getElementById("memberName").innerText=`‡∏Ñ‡∏∏‡∏ì ${m.name} ‚Ä¢ ${m.customer_type}`;

  const w=await (await fetch(`${API_URL}?action=wallet&memberId=${m.member_id}`)).json();

  document.getElementById("redeemPts").innerText=w.points.redeem;
  document.getElementById("levelPts").innerText=w.points.level;

  // expire logic
  const b=w.points_expire||[];
  const pos=b.find(x=>x.points>0);
  const neg=b.find(x=>x.points<0);

  if(pos){
    document.getElementById("expireText").innerText=`‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${thai(pos.expire)}`;
  }else if(neg){
    document.getElementById("expireText").innerText=`‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${Math.abs(neg.points)} ‡πÅ‡∏ï‡πâ‡∏°`;
  }

  // coupon redeem
  const catalog=[
    {code:"C50",name:"‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó",cost:50},
    {code:"C100",name:"‡∏•‡∏î 100 ‡∏ö‡∏≤‡∏ó",cost:100},
    {code:"P10",name:"‡∏•‡∏î 10%",cost:150}
  ];
  const box=document.getElementById("redeemCatalog");
  catalog.forEach(c=>{
    const d=document.createElement("div");
    d.className="box coupon";
    d.innerHTML=`<div>${c.name}<div class="muted">‡πÉ‡∏ä‡πâ ${c.cost} ‡πÅ‡∏ï‡πâ‡∏°</div></div>
      <button>‡πÅ‡∏•‡∏Å</button>`;
    d.querySelector("button").onclick=async()=>{
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å?"))return;
      await fetch(`${API_URL}?action=redeem_coupon&memberId=${m.member_id}&code=${c.code}`);
      location.reload();
    };
    box.appendChild(d);
  });

  // history
  const h=await (await fetch(`${API_URL}?action=history&memberId=${m.member_id}`)).json();
  const s=document.getElementById("serviceHist");
  h.receipts.forEach(r=>{
    s.innerHTML+=`<div class="item">
      <b>${r.service}</b><br>
      ‡∏¢‡∏≠‡∏î ${r.price} ‡∏ö‡∏≤‡∏ó ‚Ä¢ ${thai(r.receipt_date)}
    </div>`;
  });

  const c=document.getElementById("couponHist");
  h.coupons_used.forEach(x=>{
    c.innerHTML+=`<div class="item">
      ${x.coupon_name}<br>
      ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${thai(x.used_date)}
    </div>`;
  });
}
main();
</script>
</body>
</html>
