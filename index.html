<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:#f5f7fb;}
    .wrap{max-width:420px; margin:0 auto; padding:16px;}
    .card{background:#fff; border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .title{font-size:18px; font-weight:700; color:#0b2b5a; margin:0 0 8px}
    .muted{color:#6b7280; font-size:13px}
    .btn{width:100%; border:0; border-radius:12px; padding:12px 14px; font-weight:700; margin-top:10px; background:#0b63ce; color:#fff}
    .row{display:flex; gap:10px; margin-top:12px}
    .mini{flex:1; background:#f3f6ff; border-radius:14px; padding:12px}
    .big{font-size:22px; font-weight:800; color:#0b2b5a; margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="title">บัตรสมาชิก</p>
      <div class="muted" id="status">กำลังโหลด...</div>

      <div class="row">
        <div class="mini">
          <div class="muted">แต้มแลกของ</div>
          <div class="big" id="redeemPts">-</div>
          <div class="muted">1 แต้ม = 1 บาท</div>
        </div>
        <div class="mini">
          <div class="muted">แต้มสะสมเลเวล</div>
          <div class="big" id="levelPts">-</div>
          <div class="muted">ไม่มีวันหมดอายุ</div>
        </div>
      </div>

      <button class="btn" id="btnProfile">แสดงชื่อจาก LINE</button>
    </div>
  </div>

 <script>
const LIFF_ID = "2008701497-IOxPqnn3"; // ← LIFF ID ของต่อ
const API_URL = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec"; 

async function main() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    const userId = profile.userId;
    const displayName = profile.displayName;

    // 1) เรียก MEMBER (สมัคร/ดึงข้อมูลสมาชิก)
    const res = await fetch(
      `${API_URL}?action=member&userId=${userId}&name=${encodeURIComponent(displayName)}`
    );
    const data = await res.json();

    // แสดงข้อความต้อนรับ
    document.getElementById("status").innerText = `สวัสดีคุณ ${data.name}`;

    // 2) เรียก WALLET (แต้ม + คูปอง)
    const walletRes = await fetch(
      `${API_URL}?action=wallet&memberId=${data.member_id}`
    );
    const wallet = await walletRes.json();

    // แสดงแต้ม 2 ประเภท
    const redeem = wallet.points?.redeem ?? 0;
    const level = wallet.points?.level ?? 0;

    document.getElementById("redeemPts").innerText = redeem;
    document.getElementById("levelPts").innerText = level;


    // 3) แสดงคูปองในหน้า Member
    // สร้างหัวข้อ "คูปองของคุณ" ไว้ใต้การ์ดหลัก
    let couponSection = document.getElementById("couponSection");

    // ถ้ายังไม่มี section นี้ ให้สร้างใหม่
    if (!couponSection) {
      couponSection = document.createElement("div");
      couponSection.id = "couponSection";
      couponSection.style.marginTop = "12px";

      const title = document.createElement("div");
      title.style.cssText = "font-weight:800;color:#0b2b5a;margin:12px 0 8px;";
      title.innerText = "คูปองของคุณ";

      couponSection.appendChild(title);
      document.querySelector(".card").appendChild(couponSection);
    }

    // ล้างคูปองเก่าก่อน (กันซ้ำเวลารีเฟรช)
    couponSection.querySelectorAll(".couponCard").forEach(el => el.remove());

    // ถ้าไม่มีคูปอง
    if (!wallet.coupons || wallet.coupons.length === 0) {
      const empty = document.createElement("div");
      empty.className = "couponCard";
      empty.style.cssText = "padding:12px;border-radius:12px;background:#f3f6ff;color:#6b7280;";
      empty.innerText = "ยังไม่มีคูปอง — กดแลกแต้มเพื่อรับคูปองได้เลย";
      couponSection.appendChild(empty);
    } else {
      // มีคูปอง → สร้างการ์ดแสดงทีละใบ
      wallet.coupons.forEach(c => {
        const card = document.createElement("div");
        card.className = "couponCard";
        card.style.cssText =
          "padding:12px;border-radius:12px;background:#f3f6ff;margin-top:8px;";

        const valueText =
          c.type === "percent"
            ? `${c.value}%`
            : `${c.value} บาท`;

        card.innerHTML = `
          <div style="font-weight:800;color:#0b2b5a;">${c.name}</div>
          <div style="color:#374151;margin-top:4px;">มูลค่า: ${valueText}</div>
          <div style="color:#6b7280;margin-top:2px;">ขั้นต่ำ: ${c.min || 0} บาท</div>
          <div style="color:#6b7280;margin-top:2px;">หมดอายุ: ${c.expire || "-"}</div>
        `;

        couponSection.appendChild(card);
      });
    }

    // ปุ่มแสดงชื่อ (ของเดิม) — ปรับให้โชว์ข้อมูลสมาชิกด้วย
    document.getElementById("btnProfile").onclick = () => {
      alert(
        "ชื่อ: " + data.name +
        "\nMember ID: " + data.member_id +
        "\nLevel: " + data.level
      );
    };

  } catch (e) {
    document.getElementById("status").innerText =
      "เปิด LIFF ไม่สำเร็จ: " + e;
  }
  function formatThaiDate(isoDate) {
  if (!isoDate) return "-";

  const d = new Date(isoDate);
  const months = [
    "มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน",
    "กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"
  ];

  const day = d.getDate();
  const month = months[d.getMonth()];
  const year = d.getFullYear() + 543;

  return `${day} ${month} ${year}`;
  }
}
main();
</script>
</body>
</html>
