<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MIRO Member</title>
<style>
body{font-family:system-ui;background:#0b1220;color:#e5e7eb;margin:16px}
.card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:14px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
button{width:100%;padding:12px;border-radius:12px;border:0;background:#fbbf24;font-weight:700;margin-top:10px}
.item{border-top:1px solid #1f2937;padding:10px 0}
</style>
</head>
<body>

<h2>MIRO Member</h2>

<div class="card">
  <input id="memberId" placeholder="Member ID">
  <button onclick="loadAll()">โหลดข้อมูล</button>
  <div id="summary"></div>
</div>

<div class="card">
  <h3>แต้ม + วันหมดอายุ</h3>
  <div id="points"></div>
</div>

<div class="card">
  <h3>คูปองของฉัน</h3>
  <div id="coupons"></div>
</div>

<div class="card">
  <h3>แลกคูปอง</h3>
  <input id="cname" value="ส่วนลด 100 บาท">
  <input id="cvalue" value="100">
  <input id="ccost" value="100">
  <button onclick="redeem()">แลก</button>
  <div id="redeemResult"></div>
</div>

<div class="card">
  <h3>ประวัติทำความสะอาด</h3>
  <div id="jobs"></div>
</div>

<div class="card">
  <h3>ประวัติใช้คูปอง</h3>
  <div id="couponHistory"></div>
</div>

<script>
const API_BASE="https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";
function qs(o){return new URLSearchParams(o).toString();}

async function loadAll(){
  const id=memberId.value;
  const w=await (await fetch(API_BASE+"?"+qs({action:"wallet_detail",memberId:id}))).json();
  const h=await (await fetch(API_BASE+"?"+qs({action:"member_history",memberId:id}))).json();

  summary.innerHTML=`แต้ม: ${w.points.redeem}`;
  points.innerHTML=w.points.expiry_list.map(x=>`
    <div class="item">${x.points} แต้ม หมด ${x.expire_text}</div>
  `).join("");

  coupons.innerHTML=(w.coupons||[]).map(c=>`
    <div class="item">${c.name} หมด ${new Date(c.expire_date).toLocaleDateString()}</div>
  `).join("")||"ไม่มี";

  jobs.innerHTML=(h.jobs||[]).map(j=>`
    <div class="item">${j.service_name} (${j.status})</div>
  `).join("");

  couponHistory.innerHTML=(h.coupons||[]).map(c=>`
    <div class="item">${c.coupon_name} (${c.status})</div>
  `).join("");
}

async function redeem(){
  const r=await fetch(API_BASE+"?"+qs({
    action:"redeem_coupon",
    memberId:memberId.value,
    coupon_name:cname.value,
    discount_type:"baht",
    discount_value:cvalue.value,
    cost_points:ccost.value
  }));
  const j=await r.json();
  redeemResult.innerHTML=j.success?"แลกสำเร็จ":"ผิดพลาด";
  loadAll();
}
</script>
</body>
</html>
