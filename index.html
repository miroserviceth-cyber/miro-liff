<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miro Member</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:system-ui;margin:0;background:#f5f7fb;color:#0b2b5a}
.wrap{max-width:420px;margin:0 auto;padding:16px}
.card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 22px rgba(0,0,0,.08)}
.title{font-size:18px;font-weight:900;margin-bottom:6px}
.muted{color:#6b7280;font-size:13px}
.row{display:flex;gap:10px;margin-top:14px}
.mini{flex:1;background:#f3f6ff;border-radius:16px;padding:14px}
.mini .label{font-size:13px;color:#6b7280}
.mini .value{font-size:26px;font-weight:900;margin:6px 0}
.sec{margin-top:18px}
.box{background:#f3f6ff;border-radius:16px;padding:14px;margin-top:10px}
.line{font-size:13px;color:#374151;margin-top:4px}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <div class="title">บัตรสมาชิก</div>
  <div class="muted" id="status">กำลังโหลด...</div>

  <div class="row">
    <div class="mini">
      <div class="label">แต้ม Redeem</div>
      <div class="value" id="redeemPts">0</div>
      <div class="label">หมดอายุ 90 วัน</div>
    </div>
    <div class="mini">
      <div class="label">แต้ม Level</div>
      <div class="value" id="levelPts">0</div>
      <div class="label">ไม่หมดอายุ</div>
    </div>
  </div>
</div>

<div class="sec">
  <div class="title">คูปองของคุณ</div>
  <div id="couponBox"></div>
</div>

<div class="sec">
  <div class="title">ประวัติการใช้บริการ</div>
  <div id="historyBox"></div>
</div>

</div>

<script>
const LIFF_ID = "2008701497-NW5Xis1n";
const API_URL = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

function fmt(d){
  if(!d) return "-";
  const x = new Date(d);
  return x.getDate()+"/"+(x.getMonth()+1)+"/"+(x.getFullYear()+543);
}

async function main(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }

  const profile = await liff.getProfile();

  // 1) member
  const mRes = await fetch(
    `${API_URL}?action=member&userId=${profile.userId}&name=${encodeURIComponent(profile.displayName)}`
  );
  const member = await mRes.json();

  document.getElementById("status").innerText =
    `สวัสดีคุณ ${member.name} • ${member.customer_type || "ทั่วไป"}`;

  // 2) wallet
  const wRes = await fetch(
    `${API_URL}?action=wallet&memberId=${member.member_id}`
  );
  const wallet = await wRes.json();

  document.getElementById("redeemPts").innerText = wallet.points.redeem || 0;
  document.getElementById("levelPts").innerText  = wallet.points.level || 0;

  // coupons
  const cBox = document.getElementById("couponBox");
  cBox.innerHTML = "";
  if(!wallet.coupons || wallet.coupons.length===0){
    cBox.innerHTML = `<div class="box muted">ยังไม่มีคูปอง</div>`;
  }else{
    wallet.coupons.forEach(c=>{
      cBox.innerHTML += `
        <div class="box">
          <div><b>${c.name}</b></div>
          <div class="line">ส่วนลด: ${
            c.discount_type==="percent"
            ? c.discount_value+"%"
            : c.discount_value+" บาท"
          }</div>
          <div class="line">หมดอายุ: ${fmt(c.expire_date)}</div>
        </div>
      `;
    });
  }

  // history
  const hRes = await fetch(
    `${API_URL}?action=history&memberId=${member.member_id}`
  );
  const hist = await hRes.json();

  const hBox = document.getElementById("historyBox");
  hBox.innerHTML = "";

  if(!hist.receipts || hist.receipts.length===0){
    hBox.innerHTML = `<div class="box muted">ยังไม่มีประวัติ</div>`;
  }else{
    hist.receipts.forEach(r=>{
      hBox.innerHTML += `
        <div class="box">
          <div><b>${r.service}</b></div>
          <div class="line">ยอด: ${r.price} บาท</div>
          <div class="line">วันที่: ${fmt(r.receipt_date)}</div>
        </div>
      `;
    });
  }
}

main();
</script>
</body>
</html>
