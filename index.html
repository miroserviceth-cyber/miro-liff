<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miro Member</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family:system-ui;
  margin:0;
  background:#f4f6fb;
  color:#0b2b5a
}
.wrap{max-width:420px;margin:0 auto;padding:16px}

/* ===== MEMBER CARD ===== */
.card{
  position:relative;
  background:linear-gradient(135deg,#0b63ce,#0a3f8f);
  color:#fff;
  border-radius:22px;
  padding:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.18);
  overflow:hidden
}
.logo{
  width:56px;
  opacity:.95
}
.level{
  font-size:13px;
  opacity:.9;
  margin-top:6px
}
.points{
  font-size:44px;
  font-weight:900;
  margin:8px 0 2px
}
.expire{
  font-size:13px;
  opacity:.9
}
.card-footer{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  opacity:.85;
  margin-top:14px
}

/* ===== SECTION ===== */
.sec{margin-top:18px}
.h{font-weight:900;margin-bottom:8px}

/* ===== COUPONS ===== */
.coupon-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px
}
.coupon{
  background:#fff;
  border-radius:14px;
  padding:10px;
  box-shadow:0 4px 10px rgba(0,0,0,.06)
}
.coupon .name{
  font-weight:800;
  font-size:14px
}
.coupon .cost{
  font-size:12px;
  color:#6b7280;
  margin-top:2px
}
.coupon button{
  margin-top:6px;
  width:100%;
  border:0;
  border-radius:999px;
  padding:6px;
  font-size:12px;
  font-weight:700;
  background:#16a34a;
  color:#fff
}

/* ===== HISTORY ===== */
.toggle{cursor:pointer}
.box{
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.06)
}
.item{
  border-top:1px solid #e5e7eb;
  padding-top:8px;
  margin-top:8px;
  font-size:13px
}
.hide{display:none}
.muted{color:#6b7280;font-size:13px}
</style>
</head>

<body>
<div class="wrap">

<!-- MEMBER CARD -->
<div class="card">
  <img src="https://i.ibb.co/whbnRx7c/D.jpg" class="logo">
  <div class="level" id="levelText">‡∏£‡∏∞‡∏î‡∏±‡∏ö -</div>
  <div class="points" id="redeemPts">0</div>
  <div class="expire" id="expireText">-</div>

  <div class="card-footer">
    <div>‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° <b id="levelPts">0</b></div>
    <div>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <b id="usedPts">0</b></div>
  </div>
</div>

<!-- COUPON -->
<div class="sec">
  <div class="h">‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>
  <div class="coupon-grid" id="redeemCatalog"></div>
</div>

<!-- HISTORY -->
<div class="sec">
  <div class="h toggle" onclick="toggle('serviceHist')">üìÑ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
  <div id="serviceHist" class="box hide"></div>
</div>

<div class="sec">
  <div class="h toggle" onclick="toggle('couponHist')">üéü ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á</div>
  <div id="couponHist" class="box hide"></div>
</div>

</div>

<script>
const LIFF_ID="2008701497-IOxPqnn3";
const API_URL="https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

function toggle(id){
  document.getElementById(id).classList.toggle("hide");
}
function thai(d){
  const x=new Date(d);
  return `${x.getDate()}/${x.getMonth()+1}/${x.getFullYear()+543}`;
}

async function main(){
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()){liff.login();return;}

  const p=await liff.getProfile();
  const m=await (await fetch(`${API_URL}?action=member&userId=${p.userId}&name=${p.displayName}`)).json();
  const w=await (await fetch(`${API_URL}?action=wallet&memberId=${m.member_id}`)).json();

  document.getElementById("levelText").innerText=`‡∏£‡∏∞‡∏î‡∏±‡∏ö ${m.level || "-"}`;
  document.getElementById("redeemPts").innerText=w.points.redeem;
  document.getElementById("levelPts").innerText=w.points.level;

  let used=0,expireInfo="-";
  (w.points_expire||[]).forEach(b=>{
    if(b.points<0) used+=Math.abs(b.points);
    if(b.points>0) expireInfo=`${b.points} ‡πÅ‡∏ï‡πâ‡∏° ‡∏´‡∏°‡∏î ${thai(b.expire)}`;
  });
  document.getElementById("usedPts").innerText=used;
  document.getElementById("expireText").innerText=expireInfo;

  // coupon catalog
  const catalog=[
    {code:"C50",name:"‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó",cost:50},
    {code:"C100",name:"‡∏•‡∏î 100 ‡∏ö‡∏≤‡∏ó",cost:100},
    {code:"P10",name:"‡∏•‡∏î 10%",cost:150}
  ];
  const box=document.getElementById("redeemCatalog");
  catalog.forEach(c=>{
    const d=document.createElement("div");
    d.className="coupon";
    d.innerHTML=`
      <div class="name">${c.name}</div>
      <div class="cost">‡πÉ‡∏ä‡πâ ${c.cost} ‡πÅ‡∏ï‡πâ‡∏°</div>
      <button>‡πÅ‡∏•‡∏Å</button>
    `;
    d.querySelector("button").onclick=async()=>{
      if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á?"))return;
      await fetch(`${API_URL}?action=redeem_coupon&memberId=${m.member_id}&code=${c.code}`);
      location.reload();
    };
    box.appendChild(d);
  });

  // history
  const h=await (await fetch(`${API_URL}?action=history&memberId=${m.member_id}`)).json();
  h.receipts.forEach(r=>{
    serviceHist.innerHTML+=`<div class="item">
      <b>${r.service}</b><br>‡∏¢‡∏≠‡∏î ${r.price} ‡∏ö‡∏≤‡∏ó ‚Ä¢ ${thai(r.receipt_date)}
    </div>`;
  });
  h.coupons_used.forEach(c=>{
    couponHist.innerHTML+=`<div class="item">
      ${c.coupon_name} ‚Ä¢ ${thai(c.used_date)}
    </div>`;
  });
}
main();
</script>
</body>
</html>
