<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MIRO Staff – งานล่าสุด</title>
<style>
body{font-family:system-ui;background:#0b1220;color:#e5e7eb;margin:16px}
.card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-bottom:14px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
button{width:100%;padding:12px;border-radius:12px;border:0;background:#fbbf24;font-weight:700;margin-top:10px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.muted{color:#94a3b8;font-size:13px}
.ok{color:#22c55e}.bad{color:#ef4444}
</style>
</head>
<body>

<h2>MIRO Staff – งานล่าสุด</h2>

<div class="card">
  <div class="muted">ใส่ STAFF_KEY (จำกัดสิทธิ์พนักงาน)</div>
  <input id="staffKey" placeholder="STAFF_KEY">
  <button onclick="saveKey()">บันทึก Key</button>
  <div id="keyState" class="muted"></div>
</div>

<div class="card">
  <div class="row">
    <button onclick="loadJob()">ดึงงานล่าสุด</button>
    <button onclick="goHistory()">ดูประวัติงาน</button>
  </div>
  <div id="jobBox" class="muted">ยังไม่ได้โหลดงาน</div>
</div>

<div class="card">
  <h3>ปิดงาน</h3>

  <label>Job ID</label>
  <input id="jobId">

  <label>ประเภทการชำระเงิน</label>
  <select id="payType">
    <option value="">-</option>
    <option>เงินสด</option>
    <option>โอน</option>
    <option>อื่นๆ</option>
  </select>

  <label>Coupon ID (ถ้ามี)</label>
  <input id="couponId">

  <label>ชื่อคูปอง</label>
  <input id="couponName">

  <label>ส่วนลด (บาท)</label>
  <input id="couponDiscount" value="0">

  <label>ค่าเพิ่มหน้างาน</label>
  <input id="extraFee" value="0">

  <label>นัดถัดไป (YYYY-MM-DD หรือข้อความ)</label>
  <input id="nextVisit">

  <button onclick="finish()">ปิดงาน + ส่งสรุป</button>
  <div id="result" class="muted"></div>
</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

function saveKey(){
  localStorage.setItem("MIRO_STAFF_KEY",staffKey.value.trim());
  renderKey();
}
function renderKey(){
  keyState.innerHTML = localStorage.getItem("MIRO_STAFF_KEY") ? "ตั้งค่าแล้ว" : "ยังไม่ตั้งค่า";
}
function qs(o){return new URLSearchParams(o).toString();}
function key(){return localStorage.getItem("MIRO_STAFF_KEY")||"";}

async function loadJob(){
  const r = await fetch(API_BASE+"?"+qs({action:"staff_job",key:key()}));
  const j = await r.json();
  if(j.error){jobBox.innerHTML=j.error;return;}
  jobBox.innerHTML = `
    <b>${j.job_id}</b><br>
    ลูกค้า: ${j.customer_name}<br>
    ที่อยู่: ${j.customer_address}<br>
    บริการ: ${j.service_name}<br>
    ราคา: ${j.price} | เดินทาง: ${j.travel_fee}
  `;
  jobId.value=j.job_id;
}

async function finish(){
  const data={
    action:"finish_job",
    key:key(),
    jobId:jobId.value,
    payment_type:payType.value,
    coupon_id:couponId.value,
    coupon_name:couponName.value,
    coupon_discount:couponDiscount.value,
    extra_fee:extraFee.value,
    next_visit:nextVisit.value
  };
  const r = await fetch(API_BASE+"?"+qs(data));
  const j = await r.json();
  result.innerHTML = j.success ? "สำเร็จ "+j.receipt_id : j.error;
}

function goHistory(){location.href="staff-2.html";}
renderKey();
</script>
</body>
</html>
