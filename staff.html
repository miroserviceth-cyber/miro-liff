<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miro Staff</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{font-family:system-ui;margin:0;background:#f5f7fb}
    .wrap{max-width:420px;margin:0 auto;padding:16px}
    .card{
      background:#fff;
      border-radius:18px;
      padding:16px;
      box-shadow:0 8px 22px rgba(0,0,0,.08)
    }
    .title{font-size:18px;font-weight:800;margin-bottom:8px}
    .muted{color:#6b7280;font-size:13px}
    .job{
      background:#f3f6ff;
      border-radius:14px;
      padding:14px;
      margin-top:12px
    }
    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px;
      font-size:15px;
      font-weight:800;
      background:#16a34a;
      color:#fff;
      margin-top:12px
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="title">งานวันนี้</div>
    <div class="muted" id="status">กำลังโหลดงาน...</div>

    <div id="jobBox"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const LIFF_ID = "2008701497-NW5Xis1n";
const API_URL = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

async function main(){
  try{
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    const res = await fetch(`${API_URL}?action=staff_job`);
    const job = await res.json();

    if(job.error){
      document.getElementById("status").innerText = job.error;
      return;
    }

    if(!job.job_id){
      document.getElementById("status").innerText = "ข้อมูลงานไม่สมบูรณ์";
      return;
    }

    document.getElementById("status").innerText = "แตะเพื่อจบงาน";

    const box = document.getElementById("jobBox");
    box.innerHTML = `
      <div class="job">
        <b>${job.service}</b><br>
        ราคา ${job.price} บาท
        <button class="btn" onclick="finishJob('${job.job_id}')">
          จบงาน
        </button>
      </div>
    `;

  }catch(e){
    document.getElementById("status").innerText = "ERROR: " + e;
  }
}

async function finishJob(jobId){
  if(!confirm("ยืนยันจบงานนี้?")) return;

  document.getElementById("status").innerText = "กำลังจบงาน...";

  const res = await fetch(
    `${API_URL}?action=finish_job&jobId=${jobId}`
  );
  const data = await res.json();

  if(data.success){
    document.getElementById("status").innerText = "จบงานเรียบร้อย ระบบส่งใบเสร็จให้ลูกค้าแล้ว";
    document.getElementById("jobBox").innerHTML = "";
  }else{
    document.getElementById("status").innerText = data.error || "เกิดข้อผิดพลาด";
  }
}

main();
</script>
</body>
</html>

