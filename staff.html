<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miro Staff</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{font-family:system-ui;margin:0;background:#f5f7fb;color:#0b2b5a}
    .wrap{max-width:420px;margin:0 auto;padding:16px}
    .card{background:#fff;border-radius:18px;padding:16px;box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .title{font-size:18px;font-weight:900;margin:0 0 6px}
    .muted{color:#6b7280;font-size:13px}
    .job{background:#f3f6ff;border-radius:16px;padding:14px;margin-top:12px}
    .line{font-size:13px;color:#374151;margin-top:6px}
    .btn{width:100%;border:0;border-radius:14px;padding:14px;font-size:15px;font-weight:900;background:#16a34a;color:#fff;margin-top:12px}
    .btn2{width:100%;border:0;border-radius:14px;padding:14px;font-size:15px;font-weight:900;background:#0b63ce;color:#fff;margin-top:12px}
    .input{width:100%;padding:12px;border-radius:12px;border:1px solid #dbe3f5;margin-top:10px}
    .back{color:#0b63ce;font-weight:700;margin-bottom:10px;cursor:pointer}
    .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px;font-weight:700}
    .monthly{background:#dcfce7;color:#166534}
    .normal{background:#e5e7eb;color:#374151}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="title">งานวันนี้</div>
    <div class="muted" id="status">กำลังโหลด...</div>
    <div id="content"></div>
  </div>
</div>

<script>
const LIFF_ID = "2008701497-NW5Xis1n";
const API_URL = "https://script.google.com/macros/s/AKfycbzmHnsk7fadmCwyXduQkPyhITIUI4deTeZI_ZGTW58bsUr_v2QakqLj0Vc3dFd1_dB6/exec";

let JOBS = [];

async function main(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  loadJobs();
}

/* ================= โหลดรายการงาน ================= */
async function loadJobs(){
  document.getElementById("status").innerText = "กำลังโหลดรายการงาน...";
  const res = await fetch(`${API_URL}?action=staff_jobs`);
  const data = await res.json();

  if(!Array.isArray(data) || data.length === 0){
    document.getElementById("status").innerText = "ยังไม่มีงานค้าง";
    document.getElementById("content").innerHTML = "";
    return;
  }

  JOBS = data;
  document.getElementById("status").innerText = "เลือกงานที่ต้องการ";
  renderJobList();
}

/* ================= หน้ารายการงาน ================= */
function renderJobList(){
  const box = document.getElementById("content");
  box.innerHTML = "";

  JOBS.forEach(j=>{
    const badge =
      j.customer_type === "รายเดือน"
        ? `<span class="badge monthly">รายเดือน (${j.remain_times} ครั้ง)</span>`
        : `<span class="badge normal">ทั่วไป</span>`;

    const div = document.createElement("div");
    div.className = "job";
    div.innerHTML = `
      <div style="font-weight:900">${j.service_name}</div>
      <div class="line">ลูกค้า: ${j.customer_name}</div>
      <div class="line">วัน/เวลา: ${j.job_date || "-"}</div>
      <div class="line">${badge}</div>
      <button class="btn2" onclick="openJob('${j.job_id}')">ดูรายละเอียด</button>
    `;
    box.appendChild(div);
  });
}

/* ================= หน้ารายละเอียดงาน ================= */
function openJob(jobId){
  const j = JOBS.find(x=>x.job_id===jobId);
  if(!j) return;

  const box = document.getElementById("content");
  document.getElementById("status").innerText = "รายละเอียดงาน";

  box.innerHTML = `
    <div class="back" onclick="renderJobList()">← กลับไปรายการงาน</div>

    <div class="job">
      <div style="font-weight:900">${j.service_name}</div>
      <div class="line">ลูกค้า: ${j.customer_name}</div>
      <div class="line">ที่อยู่: ${j.customer_address}</div>
      <div class="line">ประเภทลูกค้า: ${j.customer_type}</div>

      ${j.customer_type==="รายเดือน"
        ? `<div class="line">แพ็กเกจ: ${j.package_name} (เหลือ ${j.remain_times} ครั้ง)</div>`
        : ``}

      <div class="line">ราคา: ${j.price} บาท</div>
      <div class="line">ค่าเดินทาง: ${j.travel_fee} บาท</div>

      <select class="input" id="payment_type">
        <option value="">ไม่เปลี่ยนวิธีชำระ</option>
        <option value="เงินสด">เงินสด</option>
        <option value="โอน">โอน</option>
      </select>

      <input class="input" id="coupon_name" placeholder="ชื่อคูปอง (ถ้ามี)">
      <input class="input" id="coupon_discount" type="number" placeholder="ส่วนลด (บาท)">
      <input class="input" id="extra_fee" type="number" placeholder="ค่าเพิ่มหน้างาน (บาท)">

      <input class="input" id="next_visit" type="date">

      <button class="btn" onclick="finishJob('${j.job_id}')">จบงานนี้</button>
    </div>
  `;
}

/* ================= จบงาน ================= */
async function finishJob(jobId){
  if(!confirm("ยืนยันจบงานนี้?")) return;

  document.getElementById("status").innerText = "กำลังจบงาน...";

  const url =
    `${API_URL}?action=finish_job`
    + `&jobId=${jobId}`
    + `&payment_type=${encodeURIComponent(payment_type.value)}`
    + `&coupon_name=${encodeURIComponent(coupon_name.value)}`
    + `&coupon_discount=${coupon_discount.value}`
    + `&extra_fee=${extra_fee.value}`
    + `&next_visit=${encodeURIComponent(next_visit.value)}`;

  const res = await fetch(url);
  const data = await res.json();

  if(data.success){
    document.getElementById("status").innerText = "จบงานเรียบร้อย";
    loadJobs();
  }else{
    document.getElementById("status").innerText = "ผิดพลาด: " + data.error;
  }
}

main();
</script>
</body>
</html>
