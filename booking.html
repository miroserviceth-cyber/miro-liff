<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>จองบริการ</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#eaf4ff;
      --card:#ffffff;
      --ink:#0b2b5a;
      --muted:#47627a;
      --line:#cfe8ff;
      --primary:#0284c7;
    }
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto;background:var(--bg);color:var(--ink)}
    .wrap{max-width:520px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:16px;padding:16px;border:1px solid var(--line);box-shadow:0 10px 22px rgba(0,0,0,.08)}
    h1{font-size:18px;margin:0;font-weight:900}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    label{display:block;margin-top:12px;font-size:12px;color:var(--muted)}
    input,select,textarea{
      width:100%;box-sizing:border-box;margin-top:6px;
      padding:12px;border-radius:12px;border:1px solid var(--line);
      font-size:14px;background:#fff
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      margin-top:14px;width:100%;padding:13px 14px;
      border-radius:14px;border:0;background:var(--primary);
      color:#fff;font-weight:900;cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ok{margin-top:12px;background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;border-radius:14px;padding:12px;font-size:13px;white-space:pre-wrap}
    .err{margin-top:12px;background:#fff1f2;border:1px solid #fecaca;color:#991b1b;border-radius:14px;padding:12px;font-size:13px;white-space:pre-wrap}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>จองบริการ</h1>
    <div class="sub">กรอกข้อมูลให้ครบ ระบบจะบันทึกลงตารางจอง และทีมงานจะติดต่อยืนยันนัดหมาย</div>

    <label>ประเภทบริการ</label>
    <select id="service_type">
      <option value="">เลือกบริการ</option>
      <option>ทำความสะอาดบ้าน</option>
      <option>ทำความสะอาดคอนโด</option>
      <option>ทำความสะอาดสำนักงาน</option>
      <option>Big Cleaning</option>
    </select>

    <label>ประเภทสถานที่</label>
    <select id="home_type">
      <option value="">เลือกประเภทสถานที่</option>
      <option>บ้าน</option>
      <option>คอนโด</option>
      <option>ทาวน์โฮม</option>
      <option>สำนักงาน</option>
      <option>อื่น ๆ</option>
    </select>

    <div class="row">
      <div>
        <label>วันที่</label>
        <input id="booking_date" type="date">
      </div>
      <div>
        <label>เวลา</label>
        <input id="booking_time" type="time">
      </div>
    </div>

    <label>ที่อยู่หน้างาน</label>
    <textarea id="address"></textarea>

    <div class="row">
      <div>
        <label>ขนาด/พื้นที่</label>
        <input id="size">
      </div>
      <div>
        <label>จำนวนห้อง</label>
        <input id="rooms">
      </div>
    </div>

    <label>เบอร์ติดต่อ</label>
    <input id="phone">

    <label>หมายเหตุ</label>
    <textarea id="note"></textarea>

    <button id="btn" class="btn" onclick="submitBooking()">ยืนยันการจอง</button>
    <div id="msg"></div>
  </div>
</div>

<script>
const WEBAPP = location.href.split('?')[0];
const LIFF_ID = "2008701497-JZA86efs";
let USER = null;

async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()){ liff.login(); return; }
  USER = await liff.getProfile();

  const d = new Date();
  d.setDate(d.getDate()+1);
  booking_date.value = d.toISOString().slice(0,10);
  booking_time.value = "10:00";
}

async function submitBooking(){
  const msg = document.getElementById('msg');
  const btn = document.getElementById('btn');
  msg.innerHTML = "";
  btn.disabled = true;

  try{
    if(!USER || !USER.userId){
      throw new Error("ไม่สามารถดึงข้อมูลผู้ใช้ LINE ได้ กรุณาเปิดผ่าน LINE");
    }

    const url =
      WEBAPP +
      "?action=create_booking" +
      "&line_user_id=" + encodeURIComponent(USER.userId) +
      "&name=" + encodeURIComponent(USER.displayName || "Customer") +
      "&service_type=" + encodeURIComponent(service_type.value) +
      "&home_type=" + encodeURIComponent(home_type.value) +
      "&booking_date=" + booking_date.value +
      "&booking_time=" + booking_time.value +
      "&address=" + encodeURIComponent(address.value) +
      "&phone=" + encodeURIComponent(phone.value) +
      "&note=" + encodeURIComponent(note.value) +
      "&size=" + encodeURIComponent(size.value) +
      "&rooms=" + encodeURIComponent(rooms.value);

    const r = await fetch(url);
    const text = await r.text();

    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error("ระบบตอบกลับผิดรูปแบบ"); }

    if(!data.success){
      throw new Error(data.error || "บันทึกไม่สำเร็จ");
    }

    msg.innerHTML =
      `<div class="ok">
บันทึกการจองสำเร็จ
เลขที่การจอง: ${data.booking_id}
ทีมงานจะติดต่อยืนยันนัดหมาย
</div>`;

  }catch(err){
    msg.innerHTML = `<div class="err">${err.message}</div>`;
  }finally{
    btn.disabled = false;
  }
}

init();
</script>
</body>
</html>
