<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MIRO | จองบริการ</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{
    --bg:#f8fbff;
    --card:#ffffff;
    --ink:#0b2b5a;
    --muted:#64748b;
    --line:#e2e8f0;
    --primary:linear-gradient(135deg, #1677ff, #0ea5e9);
    --primary-solid:#1677ff;
    --success:#22c55e;
    --danger:#ef4444;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto;background:var(--bg);color:var(--ink);overflow-x:hidden}
  .wrap{max-width:500px;margin:0 auto;padding:16px 16px 40px}

  /* Topbar */
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:16px;border-radius:20px;
    background:#fff;border:1px solid var(--line);
    box-shadow:0 10px 25px rgba(0,0,0,.03);
  }
  .brand .h{font-weight:900;font-size:18px;background:var(--primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .brand .s{color:var(--muted);font-size:12px;margin-top:2px}
  .pill{padding:6px 12px;border-radius:99px;background:#f1f5f9;font-size:11px;font-weight:700}

  /* Card Container */
  .card{
    margin-top:16px;background:var(--card);
    border-radius:24px;border:1px solid var(--line);
    box-shadow:0 20px 40px rgba(15,23,42,.06);
    overflow:hidden;position:relative;
  }
  .head{padding:24px 20px 16px;background:linear-gradient(180deg, #f0f7ff 0%, #ffffff 100%)}
  .head h1{margin:0;font-size:22px;font-weight:900;letter-spacing:-0.5px}
  .head p{margin:8px 0 0;color:var(--muted);font-size:13px;line-height:1.5}

  /* Step Bar */
  .stepbar{display:flex;gap:6px;margin-top:20px}
  .step{flex:1;height:6px;border-radius:10px;background:#e2e8f0;overflow:hidden}
  .step > i{display:block;height:100%;width:0;background:var(--primary);transition:0.5s width cubic-bezier(0.34, 1.56, 0.64, 1)}

  .body{padding:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:400px){ .grid{grid-template-columns:1fr} }

  label{display:block;font-size:12px;font-weight:700;color:var(--ink);margin-top:14px;margin-left:4px}
  input,select,textarea{
    width:100%;margin-top:6px;padding:14px;
    border-radius:16px;border:1.5px solid #e2e8f0;
    background:#fff;font-size:15px;outline:none;transition:.2s;
  }
  input:focus,select:focus,textarea:focus{border-color:#1677ff;box-shadow:0 0 0 4px rgba(22,119,255,0.1)}
  .req{color:var(--danger)}

  /* Terms Section Custom Style */
  .terms-box {
    margin-top: 15px; padding: 16px; background: #f8fafc;
    border: 1px solid #e2e8f0; border-radius: 18px;
    max-height: 200px; overflow-y: auto; font-size: 13px; color: #475569;
  }
  .terms-box b { color: var(--ink); display: block; margin-top: 10px; }
  .consent-wrapper {
    display: flex; align-items: center; gap: 12px;
    margin-top: 15px; padding: 16px; background: #eff6ff;
    border-radius: 16px; cursor: pointer; border: 1px solid #dbeafe;
  }
  .consent-wrapper input { width: 22px; height: 22px; margin: 0; cursor: pointer; }
  .consent-wrapper span { font-size: 14px; font-weight: 700; color: #1e40af; }

  /* Ticket Success Style */
  .ticket {
    background: #fff; border-radius: 20px; border: 1px solid var(--line);
    position: relative; padding: 30px 20px; text-align: center;
    box-shadow: 0 15px 35px rgba(0,0,0,0.05); overflow: hidden;
  }
  .ticket::before, .ticket::after {
    content: ''; position: absolute; width: 24px; height: 24px;
    background: var(--bg); border-radius: 50%; top: 60%; border: 1px solid var(--line);
  }
  .ticket::before { left: -12px; }
  .ticket::after { right: -12px; }
  .ticket-line {
    border-top: 2px dashed #e2e8f0; position: absolute;
    top: 62.5%; left: 20px; right: 20px;
  }
  .success-icon {
    width: 64px; height: 64px; background: #dcfce7; color: #22c55e;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 32px; margin: 0 auto 16px; animation: bounceIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .booking-id-badge {
    background: #f0fdf4; border: 1.5px solid #bbf7d0;
    padding: 8px 16px; border-radius: 12px; display: inline-block;
    color: #166534; font-weight: 900; font-size: 20px; letter-spacing: 1px; margin: 10px 0;
  }

  /* Summary Grid */
  .summary-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  .kv-card{ background: #f8fafc; padding: 12px; border-radius: 14px; border: 1px solid #f1f5f9; }
  .kv-card .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .kv-card .v{ font-size: 13px; font-weight: 800; color: var(--ink); margin-top: 4px; }

  /* Navigation */
  .foot{ padding: 20px; border-top: 1px solid var(--line); background: #fff; display: flex; flex-direction: column; gap: 15px; }
  .btn-row{ display: flex; gap: 10px; }
  .btn{
    flex: 1; padding: 16px; border-radius: 18px; border: 0; font-weight: 800; font-size: 16px;
    cursor: pointer; transition: 0.2s; text-align: center;
  }
  .btn-next{ background: var(--primary); color: #fff; box-shadow: 0 8px 20px rgba(22,119,255,0.2); }
  .btn-back{ background: #f1f5f9; color: var(--ink); }
  .btn:active{ transform: scale(0.96); }
  .btn:disabled{ opacity: 0.5; transform: none; }

  @keyframes bounceIn{
    0%{transform:scale(0)}
    70%{transform:scale(1.2)}
    100%{transform:scale(1)}
  }
  .shake{animation:shake .4s}
  @keyframes shake{0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}}
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="h">MIRO Cleaning</div>
      <div class="s">Professional Service</div>
    </div>
    <div id="who" class="pill">Authenticating...</div>
  </div>

  <div class="card">
    <div id="form-head" class="head">
      <h1 id="titleText">จองบริการ</h1>
      <p id="subText">ระบุรายละเอียดเพื่อให้ทีมงานประเมินราคาครับ</p>
      <div class="stepbar">
        <div class="step"><i id="p1"></i></div>
        <div class="step"><i id="p2"></i></div>
        <div class="step"><i id="p3"></i></div>
        <div class="step"><i id="p4"></i></div>
      </div>
    </div>

    <div class="body">
      <div id="msg"></div>

      <div class="stepView" id="step1">
        <label>ประเภทบริการ <span class="req">*</span></label>
        <select id="service_type">
          <option value="">เลือกบริการ</option>
          <option>ทำความสะอาดบ้าน</option>
          <option>ทำความสะอาดคอนโด/หอพัก</option>
          <option>Big Cleaning</option>
          <option>ทำความสะอาดหลังรีโนเวท</option>
          <option>Car Detailing</option>
          <option>Motorcycle Detailing</option>
        </select>
        
        <div class="grid">
          <div>
            <label>สถานที่ <span class="req">*</span></label>
            <select id="property_type">
              <option value="">เลือกประเภท</option>
              <option>บ้าน</option>
              <option>คอนโด</option>
              <option>อาคารพาณิชย์</option>
              <option>อื่นๆ</option>
            </select>
          </div>
          <div>
            <label>พื้นที่ (ตร.ม.)</label>
            <input id="area_sqm" type="number" placeholder="เช่น 35">
          </div>
        </div>

        <div class="grid">
          <div><label>ห้องนอน</label><select id="bedrooms"><option>0</option><option selected>1</option><option>2</option><option>3</option><option>4+</option></select></div>
          <div><label>ห้องน้ำ</label><select id="bathrooms"><option selected>1</option><option>2</option><option>3</option><option>4+</option></select></div>
        </div>
      </div>

      <div class="stepView" id="step2" style="display:none">
        <div class="grid">
          <div><label>วันที่นัด <span class="req">*</span></label><input id="preferred_date" type="date"></div>
          <div><label>เวลานัด <span class="req">*</span></label><input id="preferred_time" type="time"></div>
        </div>
        <label>ที่อยู่หน้างาน <span class="req">*</span></label>
        <textarea id="address" placeholder="เลขที่ห้อง/บ้านเลขที่/จุดสังเกต"></textarea>
        <label>รายละเอียดเพิ่มเติม</label>
        <textarea id="notes" placeholder="มีสัตว์เลี้ยง, ต้องการเน้นจุดไหนเป็นพิเศษ?"></textarea>
      </div>

      <div class="stepView" id="step3" style="display:none">
        <label>เบอร์โทรติดต่อ <span class="req">*</span></label>
        <input id="phone" type="tel" placeholder="08x-xxx-xxxx">
        <label>อีเมล (ถ้ามี)</label>
        <input id="email" type="email" placeholder="example@mail.com">
        <label>ช่องทางติดต่อสะดวก</label>
        <select id="contact_method">
          <option>LINE</option>
          <option>โทรศัพท์</option>
        </select>
      </div>

      <div class="stepView" id="step4" style="display:none">
        <div id="summary" class="summary-grid"></div>
        
        <label style="margin-top:20px">ข้อตกลงและเงื่อนไข</label>
        <div class="terms-box">
          <b>1. ขอบเขตงาน</b>
          บริการ ปัด-กวาด-เช็ด-ถู-ล้างห้องน้ำ-กระจกภายใน-ครัว ไม่รวมซักรีดและเคลื่อนย้ายของหนัก
          <b>2. ทรัพย์สินมีค่า</b>
          กรุณาเก็บของมีค่า เงินสด เครื่องประดับให้มิดชิดก่อนเริ่มงาน
          <b>3. การรับประกัน</b>
          รับประกันความเสียหายภายใน 24 ชม. วงเงินสูงสุดไม่เกิน 3,000 บาท
          <b>4. การเลื่อน/ยกเลิก</b>
          แจ้งล่วงหน้าอย่างน้อย 24 ชม. หากติดต่อไม่ได้หน้างาน ขอสงวนสิทธิ์คิดค่าเสียเวลา 300 บาท
          <b>5. รีวิวผลงาน</b>
          ขออนุญาตถ่ายภาพ Before/After โดยไม่ติดใบหน้าและข้อมูลส่วนตัวเพื่อการโปรโมท
        </div>

        <label class="consent-wrapper">
          <input type="checkbox" id="consent_check">
          <span>ฉันยอมรับเงื่อนไขการบริการ</span>
        </label>
      </div>

      <div class="stepView" id="step5" style="display:none">
        <div class="ticket">
          <div class="success-icon">✓</div>
          <h2 style="margin:0; font-size:22px">จองสำเร็จ!</h2>
          <p style="font-size:14px; color:var(--muted); margin:8px 0 20px">เราได้รับข้อมูลการจองของคุณแล้ว</p>
          
          <div class="booking-id-badge" id="final_booking_id">---</div>
          
          <div class="ticket-line"></div>
          
          <div style="margin-top:55px; display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:left">
            <div><div class="k" style="font-size:11px; color:var(--muted)">วันที่นัดหมาย</div><div id="res_date" style="font-weight:700"></div></div>
            <div><div class="k" style="font-size:11px; color:var(--muted)">เวลาประมาณ</div><div id="res_time" style="font-weight:700"></div></div>
          </div>

          <div style="margin-top:20px; padding:12px; background:#f8fafc; border-radius:12px; font-size:12px; color:var(--muted)">
            ทีมงานจะติดต่อกลับเพื่อยืนยันคิวภายใน 1 ชม.<br><b>กรุณาแคปหน้าจอเก็บไว้เป็นหลักฐาน</b>
          </div>
        </div>
        
        <button class="btn btn-next" style="margin-top:20px; width:100%" onclick="liff.closeWindow()">ตกลง (ปิดหน้าต่าง)</button>
      </div>

    </div>

    <div class="foot" id="nav-foot">
      <div id="stepText" style="text-align:center; font-size:12px; font-weight:800; color:var(--muted)">ขั้นตอน 1 / 4</div>
      <div class="btn-row">
        <button class="btn btn-back" id="btnBack" onclick="back()" disabled>ย้อนกลับ</button>
        <button class="btn btn-next" id="btnNext" onclick="next()">ถัดไป</button>
        <button class="btn btn-next" id="btnSend" onclick="send()" style="display:none">ยืนยันส่งข้อมูล</button>
      </div>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbw3LJtWX8R9bMIXNjhyBY3kOltxRferwjklRYop-G-hBNYc8JL8omHx8D1AEFi-i7mL/exec";
  const LIFF_ID = "2008701497-JZA86efs";

  let PROFILE = null;
  let currentStep = 1;

  async function init(){
    try {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isLoggedIn()){ liff.login(); return; }
      PROFILE = await liff.getProfile();
      document.getElementById("who").textContent = PROFILE.displayName;
      
      const d = new Date(); d.setDate(d.getDate()+1);
      document.getElementById("preferred_date").value = d.toISOString().split('T')[0];
      document.getElementById("preferred_time").value = "10:00";
      
      updateUI();
    } catch(e) { console.error(e); }
  }

  function updateUI(){
    if(currentStep === 5){
      document.getElementById("form-head").style.display = "none";
      document.getElementById("nav-foot").style.display = "none";
      document.querySelectorAll(".stepView").forEach(el => el.style.display = "none");
      document.getElementById("step5").style.display = "block";
      return;
    }

    document.querySelectorAll(".stepView").forEach((el, i) => {
      el.style.display = (i + 1 === currentStep) ? "block" : "none";
    });

    const bars = [p1, p2, p3, p4];
    bars.forEach((bar, i) => { bar.style.width = (i < currentStep) ? "100%" : "0%"; });

    document.getElementById("stepText").textContent = `ขั้นตอน ${currentStep} / 4`;
    document.getElementById("btnBack").disabled = (currentStep === 1);
    document.getElementById("btnNext").style.display = (currentStep < 4) ? "block" : "none";
    document.getElementById("btnSend").style.display = (currentStep === 4) ? "block" : "none";
    
    if(currentStep === 4) renderSummary();
  }

  function next(){
    if(validate()){
      currentStep++;
      updateUI();
      window.scrollTo(0,0);
    } else {
      const card = document.querySelector(".card");
      card.classList.add("shake");
      setTimeout(() => card.classList.remove("shake"), 400);
    }
  }

  function back(){
    if(currentStep > 1){
      currentStep--;
      updateUI();
    }
  }

  function validate(){
    const msg = document.getElementById("msg");
    msg.innerHTML = "";
    if(currentStep === 1){
      if(!service_type.value) return err("กรุณาเลือกประเภทบริการ");
      if(!property_type.value) return err("กรุณาเลือกสถานที่");
    }
    if(currentStep === 2){
      if(!address.value.trim()) return err("กรุณาระบุที่อยู่หน้างาน");
    }
    if(currentStep === 3){
      if(!phone.value.match(/^[0-9]{9,10}$/)) return err("กรุณาระบุเบอร์โทรให้ถูกต้อง");
    }
    return true;
  }

  function err(t){
    document.getElementById("msg").innerHTML = `<div style="color:var(--danger); font-size:13px; font-weight:700; text-align:center; padding:10px; background:#fff1f2; border-radius:12px; margin-bottom:10px">${t}</div>`;
    return false;
  }

  function renderSummary(){
    const data = [
      ["บริการ", service_type.value],
      ["สถานที่", property_type.value],
      ["ขนาด", area_sqm.value ? area_sqm.value + " ตร.ม." : "-"],
      ["ห้อง นอน/น้ำ", bedrooms.value + " / " + bathrooms.value],
      ["วันที่นัด", preferred_date.value],
      ["เวลานัด", preferred_time.value]
    ];
    document.getElementById("summary").innerHTML = data.map(x => `
      <div class="kv-card"><div class="k">${x[0]}</div><div class="v">${x[1]}</div></div>
    `).join("");
  }

  async function send(){
    if(!consent_check.checked){
      alert("กรุณายอมรับเงื่อนไขการบริการก่อนส่งข้อมูล");
      return;
    }

    const btn = document.getElementById("btnSend");
    btn.disabled = true;
    btn.textContent = "กำลังบันทึก...";

    const params = new URLSearchParams({
      action: "create_booking",
      line_user_id: PROFILE.userId,
      display_name: PROFILE.displayName,
      phone: phone.value,
      email: email.value,
      contact_method: contact_method.value,
      service_type: service_type.value,
      property_type: property_type.value,
      area_sqm: area_sqm.value,
      bedrooms: bedrooms.value,
      bathrooms: bathrooms.value,
      preferred_date: preferred_date.value,
      preferred_time: preferred_time.value,
      address: address.value,
      notes: notes.value
    });

    try {
      const cb = "cb_" + Date.now();
      const script = document.createElement("script");
      script.src = `${API_URL}?${params.toString()}&callback=${cb}`;
      
      window[cb] = (res) => {
        if(res.success){
          document.getElementById("final_booking_id").textContent = res.booking_id;
          document.getElementById("res_date").textContent = preferred_date.value;
          document.getElementById("res_time").textContent = preferred_time.value + " น.";
          currentStep = 5;
          updateUI();
        } else {
          alert("เกิดข้อผิดพลาด: " + res.error);
          btn.disabled = false;
          btn.textContent = "ลองอีกครั้ง";
        }
        delete window[cb];
        script.remove();
      };
      document.body.appendChild(script);
    } catch(e) {
      alert("การเชื่อมต่อล้มเหลว");
      btn.disabled = false;
    }
  }

  init();
</script>

</body>
</html>
